(()=>{var e,t,o={59616:(e,t,o)=>{"use strict";var n=o(25681);const r=e=>(e=>Array.isArray(e))(e)?e[0]:e,i=(e=>{let{scale:t,name:o,version:n,meta:{architecture:i,...s},path:a}=e;return e=>{const l=a||`models/${t}x/model.json`;if("rdn"===i)return{scale:t,path:l,modelType:"layers",packageInformation:{name:o,version:n},meta:{architecture:i,...s},inputRange:[0,255],outputRange:[0,255]};const c=e.layers.Layer;return[class extends c{beta;constructor(){super({}),this.beta=.2}call(t){return e.mul(r(t),this.beta)}static className="MultiplyBeta"},(o=>{class n extends c{scale=o;constructor(){super({})}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(r(t),this.scale,"NHWC")}static className=`PixelShuffle${t}x`}return n})(t)].forEach((t=>{e.serialization.registerClass(t)})),{scale:t,path:l,modelType:"layers",packageInformation:{name:o,version:n},meta:{architecture:i,...s},inputRange:[0,1],outputRange:[0,1]}}})({scale:2,name:"@upscalerjs/default-model",version:"1.0.0-beta.14",path:"models/model.json",meta:{C:1,D:2,G:4,G0:64,T:10,architecture:"rdn",patchSize:128,size:"slim",artifactReducing:!1,sharpening:!1,dataset:"div2k",modelFileName:"rdn-C1-D2-G4-G064-T10-x2-patchsize128-compress100-sharpen0-datadiv2k-vary_cFalse_best-val_loss_epoch494"}}),s=i,a=e=>"tensor"===e?"tensor":"base64";var l=o(39727);const c=e=>!(!Boolean(e)||!Array.isArray(e)||4!==e.length)&&e.every((e=>null===e||"number"==typeof e)),p=e=>c(e)&&null!==e[1]&&null!==e[2]&&e[1]>0&&e[2]>0;function u(e){return function(t){try{return t.shape.length===e}catch(o){}return!1}}const d=u(4),h=u(3),m=e=>e instanceof l.esB;var f;!function(e){e.UNDEFINED="undefined",e.INVALID_MODEL_TYPE="invalidModelType",e.MISSING_PATH="missingPath"}(f||(f={}));class g extends Error{type;constructor(e){super(e),this.type=e}}const y=e=>"number"==typeof e,w=e=>Array.isArray(e)&&2===e.length&&e.every(y),v=['"padding" is undefined, but "patchSize" is explicitly defined.',"Without padding, patches of images often have visible artifacting at the seams. Defining an explicit padding will resolve the artifacting.","For more information, see https://upscalerjs.com/documentation/troubleshooting#padding-is-undefined.",'To hide this warning, pass an explicit padding of "0".'].join(" "),b=['The "progress" callback was provided but "patchSize" was not defined.','Without a "patchSize", the "progress" callback will never be called.',"For more information, see https://upscalerjs.com/documentation/troubleshooting#progress-specified-without-patch-size."].join(" "),S=["The model output was not a valid tensor. UpscalerJS only supports models returning valid tensors.","This is likely an error with the model itself, not UpscalerJS.","For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-model-prediction."].join(" "),z=new Error("No defined tensors were passed to concatTensors");class E extends Error{message="The upscale request received an abort signal"}const j=['You must provide a "path" when providing a model definition',"For more information, see https://upscalerjs.com/documentation/troubleshooting#missing-model-path."].join(" "),T="There is a bug with the upscaler code. Please report this.",_=["You have provided a patchSize, but the model definition already includes an input size.","Your patchSize will be ignored.","For more information, see https://upscalerjs.com/documentation/troubleshooting#input-size-and-patch-size."].join(" "),x=new Error(["Model input sizes must be square. If you are using a model with a non-square input size and would like to request support,","please file a feature request at https://github.com/thekevinscott/upscalerjs"].join(" "));function I(e,t){switch(e){case f.MISSING_PATH:return new Error(j);case f.INVALID_MODEL_TYPE:return new Error((o=null==t?void 0:t.modelType,[`You've provided an invalid model type: ${JSON.stringify(o)}. Accepted types are "layers" and "graph".`,"For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-model-type."].join(" ")));default:return new Error(T)}var o}const O=e=>{console.warn(Array.isArray(e)?e.join("\n"):e)};function N(e){return void 0!==e&&"function"==typeof e}const A=(e,t,o)=>!(!N(e)||e.length<=1)&&(void 0===o&&"tensor"===t||"tensor"===o);async function D(e,t){let o;for(o=await e.next();!o.done;o=await e.next())t&&await t(o.value);return o.value}function k(e){return null!=e}function P(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];const i=o.filter(k);if(i.length){const t=n.tidy((()=>i.reduce(((e,t)=>t(e)),e)));return e.isDisposed||e===t||e.dispose(),t}return e}function C(e,t){return"graph"===t?n.loadGraphModel(e):n.loadLayersModel(e)}const $=e=>(e=>e instanceof n.LayersModel)(e)?e.layers[0].batchInputShape:e.inputs[0].shape,F=e=>{let{model:t}=e;const o=$(t);if(!c(o))throw new Error((n=o,[`Expected model to have a rank-4 compatible input shape. Instead got: ${JSON.stringify(n)}.`,"For more information, see https://upscalerjs.com/documentation/troubleshooting#error-with-model-input-shape."].join(" ")));var n;return o},M=(e,t)=>Math.ceil(t/e)*e,R=(e,t,o)=>{let{patchSize:n,padding:r}=t;const i=F(e);if(void 0!==n){if(n<=0)throw(e=>new Error([`Invalid patch size: ${e}. Patch size must be greater than 0.`].join(" ")))(n);if(void 0!==r&&2*r>=n)throw((e,t)=>new Error([`Invalid patch size and padding: ${e} and ${t}. Patch size must be greater than padding * 2.`].join(" ")))(n,r)}if(p(i)){if(void 0!==n&&O(_),i[1]!==i[2])throw x;return{patchSize:i[1],padding:r,modelInputShape:i}}void 0!==n&&void 0===r&&O(v);const{divisibilityFactor:s}=e.modelDefinition;if(void 0!==s){if(void 0!==n){const e=M(s,n);return e!==n&&O(((e,t,o)=>[`Invalid patch size: ${e}. The model has a defined divibility factor of ${t} and patch size must be a multiple of this number.`,`Patch size has been scaled up to ${o}.`,"\nFor more information, see https://upscalerjs.com/documentation/troubleshooting#patch-size-indivisible-by-divisibility-factor."].join(" "))(n,s,e)),{patchSize:e,padding:r,modelInputShape:[null,e,e,3]}}return{patchSize:void 0,padding:void 0,modelInputShape:[null,M(s,o[1]),M(s,o[2]),3]}}return{patchSize:n,padding:r,modelInputShape:void 0}},L={jsdelivr:(e,t,o)=>`https://cdn.jsdelivr.net/npm/${e}@${t}/${o}`,unpkg:(e,t,o)=>`https://unpkg.com/${e}@${t}/${o}`},G=["jsdelivr","unpkg"];async function U(e){let{path:t,modelType:o,packageInformation:n}=e;if(n){const e=[];for(let i=0;i<G.length;i++){const s=G[i],a=L[s];try{const e=a(n.name,n.version,t);return await C(e,o)}catch(r){e.push([s,r instanceof Error?r:new Error(`There was an unknown error: ${JSON.stringify(r)}`)])}}throw((e,t,o)=>new Error([`Could not resolve URL ${e} for package ${t.name}@${t.version}`,"Errors include:",...o.map((e=>{let[t,o]=e;return`- ${t}: ${o.message}`}))].join("\n")))(t,n,e)}return await C(t,o)}const B=async e=>{try{(e=>{if(void 0===e)throw new g(f.UNDEFINED);if("string"!=typeof(t=e.modelType||"layers")||!["layers","graph"].includes(t))throw new g(f.INVALID_MODEL_TYPE);var t;if(!e.path)throw new g(f.MISSING_PATH)})(e)}catch(o){throw o instanceof g?I(o.type,e):new Error(T)}const t=(e=>({...e}))(e);return{model:await U(t),modelDefinition:t}},J=(e,t)=>async o=>{if(t&&await n.nextFrame(),(r=e)&&r.aborted)throw Array.isArray(o)?o.forEach((e=>null==e?void 0:e.dispose())):m(o)&&o.dispose(),new E;var r},q=e=>!(!e||"object"!=typeof e)&&("patchSize"in e&&"number"==typeof e.patchSize),Y=e=>Boolean(e)&&"number"==typeof e&&e>0,H=e=>new Error((e=>["Invalid value passed to warmup in warmupSizes:",JSON.stringify(e),"For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-warmup-value."].join("\n"))(e)),V=e=>{if(q(e)){const{patchSize:t}=e;return t}return e};const W=async function(e,t,o,r){let{signal:i,awaitNextFrame:s=!1}=void 0===o?{}:o;const a=J(i||r.signal,s);await a(),await D(async function*(e,t){const{model:o,modelDefinition:r}=await e;for(const i of t){if(!q(i)&&!Y(i))throw H(i);const e=V(i);let t=n.zeros([1,e,e,3]);yield[t];const s=[r.preprocess,e=>o.predict(e),r.postprocess].filter(Boolean);for(const o of s)t=P(t,o),yield[t];t.dispose(),yield}}(e,(e=>{if(Array.isArray(e)){for(const t of e)if(!q(t)&&!Y(t))throw H(e);return e}if(q(e)||Y(e))return[e];throw H(e)})(t)),a)},K=(e,t)=>o=>{const r=e[1]*t,i=e[2]*t;return r<o.shape[1]||i<o.shape[2]?n.tidy((()=>n.slice(o,[0,0,0],[1,r,i,3]))):o},Q=e=>t=>{const o=w(e)?e[1]:255;return t.clipByValue(0,o).mul(1===o?255:1)};function X(e,t){void 0===t&&(t=0);const o=e.filter(k);if(0===o.length)throw z;const r=n.concat(o,t);return e.forEach((e=>null==e?void 0:e.dispose())),r}const Z=()=>new Error(["Environment does not support a string URL as an input format.","For more information, see https://upscalerjs.com/documentation/troubleshooting#environment-disallows-string-input."].join("\n")),ee=()=>new Error(["Environment does not support base64 as an output format.","For more information, see https://upscalerjs.com/documentation/troubleshooting#environment-disallows-base64."].join("\n")),te=e=>new Promise(((t,o)=>{const n=new Image;n.src=e,n.crossOrigin="anonymous",n.onload=()=>t(n),n.onerror=()=>o(new Error(["Failed to load image"].join(" ")))})),oe=e=>n.browser.fromPixelsAsync(e),ne=async e=>{const t=await(async e=>{if(m(e))return e;if("string"==typeof e){const t=await te(e);return oe(t)}return oe(e)})(e);if(h(t)){const e=t.expandDims(0);return t.dispose(),e}if(d(t))return t;throw(e=>new Error([`Unsupported dimensions for incoming pixels: ${e.shape.length}.`,"Only 3 or 4 rank tensors are supported."].join("\n")))(t)},re=e=>{const t=(e=>n.tidy((()=>{const[t,o]=e.shape,r=n.fill([t,o],255).expandDims(2);return e.clipByValue(0,255).concat([r],2).dataSync()})))(e),[o,r]=e.shape,i=new ImageData(r,o);i.data.set(t);const s=document.createElement("canvas");s.width=r,s.height=o;const a=s.getContext("2d");if(!a)throw new Error("No context found");return a.putImageData(i,0,0),s.toDataURL()},ie=e=>{try{new Image&&document}catch(t){throw e()}},se=(e,t,o,n)=>{let r=t;const i=0===t||o===e?0:n,s=r+o>e;let a=s?o-(e-r):0;const l=s||o===e?0:n,c=s?0:i;let p=o-(s?a:0);s&&(r=e-o),r-=c,a+=c,p-=c+l;return{pre:{origin:r,size:o},post:{origin:a,size:p},increment:o>e?e:o-i-l}},ae=(e,t,o,n)=>(e*o+t+1)/n,le=(e,t)=>{const o=e.predict(t);if(!m(o))throw new Error(S);if(d(o))return o;throw new Error((n=o.shape,[`The tensor returned by the model was not a valid rank-4 tensor. It's shape is ${JSON.stringify(n)}.}`,"UpscalerJS only supports models returning valid image-like data in four dimensional form.","For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-predicted-tensor."].join(" ")));var n};async function*ce(e,t,o,n){let{output:r,progress:i,progressOutput:s}=t,{originalImageSize:a,patchSize:l,padding:c=0}=n;const{model:p,modelDefinition:u}=o,d=u.scale||1;if(l){var h;const[t,o]=e.shape.slice(1),n=((e,t,o)=>{let[n,r]=e;const i=[];let s=0,a=0;for(;a<r;){const{pre:{origin:e,size:l},post:{origin:c,size:p},increment:u}=se(r,a,Math.min(t,r),o),d=[];for(;s<n;){const{pre:{origin:r,size:i},post:{origin:a,size:u},increment:h}=se(n,s,Math.min(t,n),o);d.push({pre:{origin:[e,r],size:[l,i]},post:{origin:[c,a],size:[p,u]}}),s+=h}i.push(d),s=0,a+=u}return i})([o,t],l,c);let f;yield;const g=n.length*n[0].length;for(let a=0;a<n.length;a++){const t=n[a],o=t.length;let l;yield[l,f];for(let n=0;n<o;n++){const{pre:c,post:h}=t[n];yield[f,l];const y=e.slice([0,...c.origin],[-1,...c.size]);yield[f,l,y];const w=le(p,y);y.dispose(),yield[f,l,w];const v=[0,h.origin[0]*d,h.origin[1]*d],b=[-1,h.size[0]*d,h.size[1]*d],S=w.slice(v,b);w.dispose(),yield[f,l,S];const z=P(S,u.postprocess,Q(u.outputRange));if(yield[f,l,z],void 0!==i&&N(i)){const e=ae(a,n,o,g);if(N(m=i)&&m.length<=1)i(e);else{const t=z.squeeze();if(A(i,r,s))i(e,t,a,n);else{const o=re(t);t.dispose(),i(e,o,a,n)}}}yield[f,l,z],l=X([l,z],2),z.dispose(),yield[f,l]}f=X([f,l],1),l.dispose(),yield[f]}const y=P(f.clone(),K(a,d));null==(h=f)||h.dispose(),yield[y];const w=y.squeeze();return y.dispose(),w}var m;i&&O(b);const f=le(p,e);yield[f];const g=P(f.clone(),u.postprocess,Q(u.outputRange),K(a,d));f.dispose(),yield[g];const y=g.squeeze();return g.dispose(),y}async function*pe(e,t,o){const r=(e=>m(e)?e.clone():e)(e),i=await ne(r);yield i;const s=i.shape,{patchSize:a,padding:l,modelInputShape:c}=R(o,t,s),u=P(i,o.modelDefinition.preprocess,(h=o.modelDefinition.inputRange,e=>w(h)&&1===h[1]?n.mul(e,1/255):e),c?(d=c,e=>{const t=e.shape[1],o=e.shape[2];return p(d)&&(d[1]>t||d[2]>o)?n.tidy((()=>{const r=Math.max(t,d[1]),i=Math.max(o,d[2]),s=n.zeros([1,t,i-o,3]),a=n.zeros([1,r-t,i,3]),l=n.concat([e,s],2);return n.concat([l,a],1)})):e}):void 0);var d,h;yield u;const f=ce(u,{output:t.output,progressOutput:t.progressOutput,progress:t.progress},o,{originalImageSize:s,patchSize:a,padding:l});let g=await f.next();for(yield g.value;!g.done;)g=await f.next(),Array.isArray(g.value)?yield[...g.value,u]:m(g.value)?yield[g.value,u]:yield u;u.dispose();const y=g.value;if("tensor"===t.output)return y;const v=re(y);return y.dispose(),v}async function ue(e,t,o){let{signal:n,awaitNextFrame:r,...i}=t;((e,t)=>{let{output:o="base64",progressOutput:n}=t;"string"==typeof e&&ie(Z),"base64"!==n&&"base64"!==o||ie(ee)})(e,{output:i.output,progressOutput:i.progressOutput});const s=J(n||o.signal,r);await s();const a=await D(pe(e,i,o),s);return await s(),a}const de=s;const he=class{_opts;_model;ready;_abortController=new AbortController;constructor(e){void 0===e&&(e={}),this._opts={...e},this._model=B(function(e){return function(e){return"function"==typeof e}(e)?e(n):e}(this._opts.model||de)),this.ready=new Promise(((e,t)=>{this._model.then((()=>W(this._model,this._opts.warmupSizes||[],void 0,{signal:this._abortController.signal}))).then(e).catch(t)}))}async execute(e,t){await this.ready;const o=await this._model;return ue(e,function(e){let{output:t,progressOutput:o,...n}=void 0===e?{}:e;return{...n,output:a(t),progressOutput:a(o||t)}}(t),{...o,signal:this._abortController.signal})}upscale=this.execute.bind(this);warmup=(()=>{var e=this;return async function(t,o){return void 0===t&&(t=[]),await e.ready,W(e._model,t,o,{signal:e._abortController.signal})}})();abort=()=>{this._abortController.abort(),this._abortController=new AbortController};dispose=async()=>{await this.ready;const{model:e}=await this._model;e.dispose()};getModel=()=>this._model},me=e=>(e=>Array.isArray(e))(e)?e[0]:e,fe=e=>{let{scale:t,name:o,version:n,meta:{architecture:r,...i},path:s}=e;return e=>{const a=s||`models/${t}x/model.json`;if("rdn"===r)return{scale:t,path:a,modelType:"layers",packageInformation:{name:o,version:n},meta:{architecture:r,...i},inputRange:[0,255],outputRange:[0,255]};const l=e.layers.Layer;return[class extends l{beta;constructor(){super({}),this.beta=.2}call(t){return e.mul(me(t),this.beta)}static className="MultiplyBeta"},(o=>{class n extends l{scale=o;constructor(){super({})}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(me(t),this.scale,"NHWC")}static className=`PixelShuffle${t}x`}return n})(t)].forEach((t=>{e.serialization.registerClass(t)})),{scale:t,path:a,modelType:"layers",packageInformation:{name:o,version:n},meta:{architecture:r,...i},inputRange:[0,1],outputRange:[0,1]}}},ge=(e,t)=>fe({scale:e,path:`models/${e}x/model.json`,name:"@upscalerjs/esrgan-medium",version:"1.0.0-beta.9",meta:{C:1,D:10,G:64,G0:64,T:10,architecture:"rdn",patchSize:3===e?129:128,size:"medium",artifactReducing:!1,sharpening:!1,dataset:"div2k",modelFileName:t}}),ye=ge(4,"rdn-C1-D10-G64-G064-T10-x4-patchsize128-compress100-sharpen0-datadiv2k-vary_cFalse_best-val_loss_epoch490");let we,ve,be,Se,ze;!function(e){e[e.INSTANTIATE=0]="INSTANTIATE",e[e.UPSCALE=1]="UPSCALE",e[e.ABORT=2]="ABORT",e[e.SET_ID=3]="SET_ID"}(we||(we={})),function(e){e[e.PROGRESS=0]="PROGRESS",e[e.SEND_CONSTS=1]="SEND_CONSTS"}(ve||(ve={}));let Ee=()=>{},je=new Promise((e=>{Ee=e}));onmessage=async e=>{let{data:{type:t,data:o}}=e;if(t===we.INSTANTIATE)if(be)console.warn("Was asked to instantiate UpscalerJS, but it already exists.");else{be=new he({model:ye});const{modelDefinition:e}=await be.getModel();ze=e.scale,postMessage({type:ve.SEND_CONSTS,data:{scale:ze,patchSize:32}}),await be.warmup([{patchSize:32}]),Ee(),console.log("UpscalerJS warmup complete.")}else if(t===we.SET_ID){try{be.abort()}catch(r){}if(!o)throw new Error("No data in set id");Se=o.id}else if(t===we.UPSCALE){if(await je,!be)throw new Error("Instantiate an Upscaler first.");const{pixels:e,shape:t,patchSize:i,padding:s}=o,a=n.tensor3d(e,t);try{await be.execute(a,{output:"tensor",patchSize:i,padding:s,progress:(e,t,o,n)=>{postMessage({type:ve.PROGRESS,data:{id:Se,rate:e,row:o,col:n,slice:t.dataSync(),shape:t.shape}}),t.dispose()}})}catch(r){if(!(r instanceof E))throw r}a.dispose()}else if(t===we.ABORT)try{be.abort()}catch(r){}}},57897:()=>{},94444:()=>{},43237:()=>{},93153:()=>{},18116:()=>{},41402:()=>{}},n={};function r(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={id:e,loaded:!1,exports:{}};return o[e].call(i.exports,i,i.exports,r),i.loaded=!0,i.exports}r.m=o,r.x=()=>{var e=r.O(void 0,[5681],(()=>r(59616)));return e=r.O(e)},r.amdD=function(){throw new Error("define cannot be used indirect")},r.amdO={},e=[],r.O=(t,o,n,i)=>{if(!o){var s=1/0;for(p=0;p<e.length;p++){o=e[p][0],n=e[p][1],i=e[p][2];for(var a=!0,l=0;l<o.length;l++)(!1&i||s>=i)&&Object.keys(r.O).every((e=>r.O[e](o[l])))?o.splice(l--,1):(a=!1,i<s&&(s=i));if(a){e.splice(p--,1);var c=n();void 0!==c&&(t=c)}}return t}i=i||0;for(var p=e.length;p>0&&e[p-1][2]>i;p--)e[p]=e[p-1];e[p]=[o,n,i]},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,o)=>(r.f[o](e,t),t)),[])),r.u=e=>"assets/js/"+e+".6f14b483.js",r.miniCssF=e=>{},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),r.p="/",r.gca=function(e){return e={}[e]||e,r.p+r.u(e)},(()=>{var e={1309:1};r.f.i=(t,o)=>{e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunk_upscalerjs_docs=self.webpackChunk_upscalerjs_docs||[],o=t.push.bind(t);t.push=t=>{var n=t[0],i=t[1],s=t[2];for(var a in i)r.o(i,a)&&(r.m[a]=i[a]);for(s&&s(r);n.length;)e[n.pop()]=1;o(t)}})(),t=r.x,r.x=()=>r.e(5681).then(t);r.x()})();