(self.webpackChunk_upscalerjs_docs=self.webpackChunk_upscalerjs_docs||[]).push([[1989,1309],{3817:(e,t,n)=>{"use strict";n.d(t,{z:()=>s});var a=n(74011),o=n(49231),r=n(61853),i=n(72269);const s=e=>{let{onClick:t,...n}=e;const s=(0,r.T)(t,"click","touch");return o.createElement(i.x5,(0,a.Z)({ref:s},n))}},19464:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Demo:()=>Le});var a=n(49231);const o="page_czoo",r="viewer_YkhD";n(78697);const i=(0,a.forwardRef)(((e,t)=>{let{img:n,zoom:o,scale:i}=e;const s=((e,t)=>{const n=(0,a.useRef)();return(0,a.useEffect)((()=>{const a=n.current;e&&t&&a&&a.getContext("2d").drawImage(e,0,0,a.width,a.height)}),[e,t,n]),n})(n,i),l=null==n?void 0:n.width,c=null==n?void 0:n.height;if(!l||!c||!i)return null;const d=l*i,u=c*i;return a.createElement("div",{id:r},a.createElement("image-comparison-viewer",{zoom:o,comparisonX:.5},a.createElement("canvas",{ref:t,width:d,height:u}),a.createElement("canvas",{ref:s,width:d,height:u})))})),s="controls_Pvw7",l="progress_ZadI",c="right_oYhH",d="progressBar_wWpI",u="bottom_vqaF";var m=n(26372),p=n.n(m);const h="controlPane_PPvZ",g="right_F3ZT",f="open_bt1f",w="bottom_wSGA",v="controlPaneInner_SXBB",E="mobile_KNhq",y="fullHeight_x09X",S="assumeHeight_K7Du",b=e=>({[g]:"right"===e,[w]:"bottom"===e});function I(e){let{children:t,open:n,position:o,height:r,mobile:i,fullHeight:s,assumeHeight:l,minHeight:c}=e;return a.createElement("div",{id:h,className:p()({...b(o),[f]:n,[E]:i,[y]:s,[S]:l}),style:{width:r?n?"calc(100% - 200px)":"calc(100%)":void 0,minHeight:c}},a.createElement("div",{id:v,className:p()({[f]:n,...b(o)}),style:{marginBottom:n||!r?0:-1*r}},t))}const z="toggle_kdxo";var _=n(3817);function C(e){let{open:t,handleToggle:n}=e;return a.createElement("div",{id:z},a.createElement(_.z,{onClick:n},(e=>e?"Hide Controls":"Show Controls")(t)))}const T="sidebar_kR7M",N="info_Du1d",x="header_eCj8",k="uploadAnother_Sr_O",D="visible_DB8H",A="mobileSidebar_BAaU",R="expanded_rzht",U="close_yFJU",P="mobileFooter_SkW3",O="open_GQNv";var j=n(72269);const M="images_pK5v",L="imageList_jGMJ",F="image_U4gi",G="loading_9RUY",$="loading_xcEK";var B=n(81184),H=n.n(B),J=n(25484);const Z=function(){const{colorMode:e}=(0,J.I)();return a.createElement("div",{className:$},a.createElement(H(),{type:"spin",color:"dark"===e?"#fff":"#000"}))};function q(e){let{searchValue:t,selectImage:n}=e;const o=(0,a.useRef)(),[r,i]=(0,a.useState)(!1),[s,l]=(0,a.useState)(),c=(0,a.useCallback)((async e=>{const t=await fetch(`https://image-search-prod.upscaler.workers.dev?q=${e}`),{response:{hits:n}}=await t.json();l(n.map((e=>({url:e.previewURL,pageURL:e.pageURL,tags:e.tags}))))}),[]);return(0,a.useEffect)((()=>(o.current&&clearTimeout(o.current),l(void 0),o.current=window.setTimeout((()=>{c(t)}),!1===r?0:800),i(!0),()=>{clearTimeout(o.current)})),[o,t]),a.createElement("div",{id:M},s?a.createElement("div",{id:L},s.map((e=>a.createElement("div",{className:F,key:e.url},a.createElement("a",{onClick:t=>{t.preventDefault(),n({src:e.url,filename:e.tags})}},a.createElement("img",{src:e.url})))))):a.createElement("div",{id:G},a.createElement(Z,null)))}let W;!function(e){e[e.UPLOAD=0]="UPLOAD",e[e.WARNING=1]="WARNING",e[e.PROCESSING=2]="PROCESSING",e[e.COMPLETE=3]="COMPLETE"}(W||(W={}));const V="animation_cGhh";function Y(){const e=(0,a.useRef)();return(e=>{const t=(0,a.useCallback)((function(n,a){void 0===n&&(n=1),void 0===a&&(a=0);const o=e.current;if(o){const e=o.width,r=o.height,i=o.getContext("2d");i.clearRect(0,0,e,r),i.beginPath(),i.arc(40+a,40,20,0,2*Math.PI),i.fill();let s=n;a>e-20-40-20&&(s=0),a<0&&(s=1);const l=1===n?a+3:a-3;window.requestAnimationFrame((()=>t(s,l)))}}),[e]);(0,a.useEffect)((()=>{t()}),[e])})(e),a.createElement("div",{id:V},a.createElement("canvas",{ref:e,style:{background:"white",width:"100%"}}))}function K(e){let{state:t,selectImage:n}=e;const[o,r]=(0,a.useState)(""),i=(0,a.useCallback)((e=>{r(e)}),[]),s=(0,a.useRef)(),[l,c]=(0,a.useState)(!1);return(0,a.useEffect)((()=>(clearTimeout(s.current),t===W.COMPLETE?s.current=window.setTimeout((()=>{c(!0)}),500):c(!1),()=>{clearTimeout(s.current)})),[t]),a.createElement("div",{id:T},a.createElement("div",{id:x},a.createElement(Y,null),a.createElement("div",{id:k,className:p()({[D]:l})},a.createElement(_.z,{variant:"primary",onClick:()=>n(void 0)},"Upload Image")),a.createElement(j.oj,{placeholder:"Search images",size:"small",onSlInput:e=>i(e.target.value)},a.createElement(j.VJ,{name:"search",slot:"suffix"})),a.createElement("small",{className:N},"Images provided from ",a.createElement("a",{target:"_blank",href:"https://pixabay.com"},"pixabay"))),a.createElement(q,{searchValue:o,selectImage:n}))}const X={actions:"actions_DIkG",left:"left_Fbqu",right:"right_zU2a"};var Q=n(74011);const ee=e=>{let{onChange:t,...n}=e;const o=(0,a.useCallback)((e=>{const n=e.target;t(n.value)}),[t]);return a.createElement(j.Jq,(0,Q.Z)({onSlChange:o},n))};function te(e){let{handleZoom:t,zoom:n,handleDownload:o,className:r}=e;const i=void 0===o;return a.createElement("div",{className:p()([X.actions,r].filter(Boolean).reduce(((e,t)=>({...e,[t]:!0})),{}))},a.createElement("div",{id:X.left},t&&a.createElement(ee,{value:n,label:"Zoom","help-text":"Control the zoom of the side-by-side original and upscaled image",min:0,max:4,step:.01,onChange:t})),a.createElement("div",{id:X.right},a.createElement(_.z,{disabled:i,size:"large",variant:"primary",onClick:o},"Download Upscaled Image")))}const ne=(e,t)=>!1!==t&&e===W.UPLOAD;function ae(e){let{state:t,selectImage:n,open:o}=e;const[r,i]=(0,a.useState)(""),s=(0,a.useCallback)((e=>{i(e)}),[]),[l,c]=(0,a.useState)(!1),d=(0,a.useCallback)((()=>{c(!0),setTimeout((()=>{window.scrollTo(0,0),document.body.scrollTop=0}),100)}),[]),u=(0,a.useCallback)((()=>{c(!1)}),[]);return a.createElement(I,{mobile:!0,open:ne(t,o),position:"bottom",assumeHeight:!l,fullHeight:l,minHeight:140},a.createElement("div",{id:A,className:p()({[R]:l})},a.createElement(j.VJ,{onClick:u,id:U,className:p()({[D]:l}),name:"x-circle",slot:"suffix"}),a.createElement("p",null,"Alternatively, you can search for sample images to upscale below."),a.createElement(j.oj,{placeholder:"Search images",size:"small",onSlFocus:d,onSlInput:e=>s(e.target.value)},a.createElement(j.VJ,{name:"search",slot:"suffix"})),l&&a.createElement(a.Fragment,null,a.createElement("small",{className:N},"Images provided from ",a.createElement("a",{target:"_blank",href:"https://pixabay.com"},"pixabay")),a.createElement(q,{searchValue:r,selectImage:n}))))}const oe=(e,t)=>!1!==t&&(e===W.COMPLETE||e===W.PROCESSING);function re(e){let{state:t,open:n,children:o}=e;return a.createElement("div",{id:P,className:p()({[O]:oe(t,n)})},o)}const ie=(e,t)=>!1!==t&&(e===W.COMPLETE||e===W.PROCESSING),se=(e,t)=>e!==W.BENCHMARKING&&t;function le(e){let{selectImage:t,state:n,handleZoom:o,zoom:r,progress:i,cancelUpscale:m,handleDownload:h}=e;const[g,f]=(0,a.useState)(!0),w=(0,a.useCallback)((()=>{f(!g)}),[g]);return a.createElement("div",{id:s},a.createElement("div",{id:l,className:p()({[c]:g,[u]:ie(n,g)})},n===W.PROCESSING&&a.createElement(_.z,{onClick:m},"Cancel Upscale"),a.createElement("div",{id:d},i)),n!==W.BENCHMARKING&&a.createElement(C,{handleToggle:w,open:g}),a.createElement(I,{open:se(n,g),position:"right"},a.createElement(K,{selectImage:t,state:n})),a.createElement(I,{open:ie(n,g),position:"bottom",height:120},a.createElement(te,{handleZoom:o,zoom:r,handleDownload:h})),a.createElement(ae,{selectImage:t,state:n,open:g}),a.createElement(re,{state:n,open:g},a.createElement(te,{handleDownload:h})))}const ce="uploadDialogue_A58Z",de="uploadPane_eE79",ue="active_QTDn",me={pane:"pane_F5g1",large:"large_kp87",small:"small_OB9L"};function pe(e){let{size:t="large",classes:n={},children:o,...r}=e;const i=p()({[me[t]]:!0,...n});return a.createElement("div",(0,Q.Z)({},r,{id:me.pane,className:i}),o)}const he="upload_Tg27";var ge=n(96315);const fe=(0,a.createContext)({handleUpload:()=>{throw new Error("Yet to be defined.")}});function we(e){let{children:t}=e;const{handleUpload:n}=(0,a.useContext)(fe),o=(0,a.useCallback)((async e=>{const t=e[0],a=await(e=>new Promise(((t,n)=>{const a=new FileReader;a.onabort=()=>n("File reading was aborted"),a.onerror=()=>n("File reading has failed"),a.onload=()=>{"string"==typeof a.result?t(a.result):n("No valid result could be found")},a.readAsDataURL(e)})))(t);n({src:a,filename:t.name})}),[n]),{getRootProps:r,getInputProps:i,isDragActive:s}=(0,ge.uI)({onDrop:o,accept:"image/jpeg, image/png",multiple:!1});return a.createElement("div",(0,Q.Z)({},r(),{id:he}),a.createElement("input",i()),t({isDragActive:s}))}function ve(e){let{size:t}=e;return a.createElement(we,null,(e=>{let{isDragActive:n}=e;return a.createElement(pe,{classes:{[ue]:n,[de]:!0},size:t},a.createElement("p",null,"Upload an image from your computer, or choose from one of the images in the search field."),a.createElement(_.z,{size:"large",variant:"primary"},n?"Drop Image":"Upload Image"))}))}const Ee="container_HH8c";function ye(e){let{children:t}=e;return a.createElement("div",{id:Ee},t)}function Se(){return a.createElement(ye,null,a.createElement("div",{id:ce},a.createElement(ve,{size:"large"})))}const be="warning_Lx5X",Ie="uploadedImage_Mcka",ze="options_y0fx",_e="left_mdbb",Ce="right_cz5g",Te=e=>a.createElement(j.oq,e);var Ne=n(81756);function xe(e){let{choose:t,downscaledCanvas:n,imgSize:o,originalSize:{width:r,height:i}}=e;const[s,l]=(0,a.useState)();return(0,a.useEffect)((()=>{l(n.toDataURL())}),[n]),a.createElement(ye,null,a.createElement(pe,null,a.createElement("div",{id:be},a.createElement(Te,{variant:"warning",open:!0},a.createElement(j.VJ,{slot:"icon",name:"exclamation-triangle"}),a.createElement("strong",null,"Large Image Detected")),a.createElement("img",{id:Ie,src:s}),a.createElement("p",null,"Your image is ",a.createElement("strong",null,r)," by ",a.createElement("strong",null,i)," pixels. Large images can take a long time to upscale in the browser."),a.createElement("p",null,"We recommend first downscaling your image to to ",a.createElement("strong",null,o.width)," by ",a.createElement("strong",null,o.height)," pixels before upscaling to demonstrate UpscalerJS."),a.createElement("p",null,a.createElement(Ne.Z,{href:"/documentation/guides/node/nodejs"},"Alternatively, you can upload the image in Node.js"),"."),a.createElement("div",{id:ze},a.createElement("div",{id:_e},a.createElement("a",{onClick:()=>t("original")},"I understand, use the original image!")),a.createElement("div",{id:Ce},a.createElement(_.z,{variant:"primary",onClick:()=>t("downscaled")},"Use the downscaled version"))))))}const ke=e=>parseInt(`${e}`,10),De=(e,t)=>{const n=(e=>{const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,t.width,t.height),t})(e),a=((e,t)=>{const n=document.createElement("canvas");return n.width=e.width*t,n.height=e.height*t,n.getContext("2d").drawImage(e,0,0,n.width,n.height),n})(n,t);return a};var Ae=n(25681);const Re="UPSCALING",Ue=e=>{const t=e.getContext("2d"),n=t.getImageData(0,0,e.width,e.height);let a=1/0;for(let o=0;o<n.height;o++)for(let e=0;e<n.width;e++){const t=4*o*n.width+4*e,r=(n.data[t]+n.data[t+1]+n.data[t+2])/3/2;r<a&&(a=r),n.data[t]=r,n.data[t+1]=r,n.data[t+2]=r}t.putImageData(n,0,0,0,0,n.width,n.height),t.drawImage(((e,t)=>{const n=document.createElement("canvas");n.width=e,n.height=t;const a=n.getContext("2d");a.save(),a.font="40px Arial Black",a.fillStyle="rgba(255,255,255,0.2)";const{width:o}=a.measureText(Re),r=o+30,i=Math.ceil(2*e/r),s=Math.ceil(2*t/70);a.rotate(-30*Math.PI/180),a.translate(-.5*e,-.5*t);for(let l=0;l<i;l++)for(let e=0;e<s;e++)a.fillText(Re,l*r,70*e+40);return n})(e.width,e.height),0,0,e.width,e.height)};var Pe=n(59616);const Oe=(e,t)=>{const[o,r]=(0,a.useState)(),[i,s]=(0,a.useState)(),[l,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)(),m=(0,a.useRef)(),{drawImage:p,createCanvas:h}={createCanvas:(0,a.useCallback)(((e,t,n)=>{if(!n)throw new Error("scale is not defined");e.getContext("2d").drawImage(t,0,0,e.width,e.height),Ue(e)}),[]),drawImage:(0,a.useCallback)(((e,t,n,a,o,r)=>{const i=new Uint8ClampedArray(4*n[1]*n[0]);let s=0,l=0;for(;s<t.length;)i[l+0]=t[s+0],i[l+1]=t[s+1],i[l+2]=t[s+2],i[l+3]=255,s+=3,l+=4;((e,t,n,a,o)=>{const r=a*n,i=o*n;e.getContext("2d").putImageData(t,r,i)})(e,new ImageData(i,n[1],n[0]),a,o,r)}),[])},g=(0,a.useRef)();(0,a.useEffect)((()=>(g.current=new Worker(new URL(n.p+n.u(1309),n.b)),g.current.postMessage({type:Pe.U.INSTANTIATE}),()=>{g.current.terminate()})),[]),(0,a.useEffect)((()=>{g.current.postMessage({type:Pe.U.SET_ID,data:{id:t}})}),[t]),(0,a.useEffect)((()=>{g.current.onmessage=e=>{let{data:{type:n,data:a}}=e;if(n===Pe.l.PROGRESS)if(l){const{rate:e,row:n,col:r,slice:s,shape:l}=a;t===a.id&&(u(e),p(m.current,s,l,i*o,r,n),1===e&&c(!1))}else console.warn("Received progress event, but we are not supposed to be upscaling.");else n===Pe.l.SEND_CONSTS&&(r(a.scale),s(a.patchSize))}}),[l,t,u]);const f=(0,a.useCallback)((async(e,t,n)=>{if(!t)throw new Error("Scale is not defined");if(!m.current)throw new Error("No canvas available");h(m.current,e,t),u(0),c(!0);const a=await Ae.browser.fromPixelsAsync(e);g.current.postMessage({type:Pe.U.UPSCALE,data:{pixels:a.dataSync(),shape:a.shape,patchSize:n,padding:2}})}),[m,h,o,c,u]),w=(0,a.useCallback)((()=>{g.current.postMessage({type:Pe.U.ABORT}),c(!1),u(void 0)}),[c,g]);return(0,a.useEffect)((()=>{const t=m.current;if(t)if(e&&o&&i)f(e,o,i);else{t.getContext("2d").clearRect(0,0,t.width,t.height)}}),[e,f,o,i,m]),{cancelUpscale:w,upscaledRef:m,progress:l?d:void 0,scale:o}},je=()=>{const[e,t]=(0,a.useState)(),[n,o]=(0,a.useState)(),[r,i]=(0,a.useState)(),[s,l]=(0,a.useState)(void 0),[c,d]=(0,a.useState)(),u=(0,a.useCallback)((()=>{o(void 0),t(void 0),d(void 0),l(void 0)}),[t,o,l,d]),m=(e=>{let{hasBeenRescaled:t,choice:n,downscaledImage:o,_originalImage:r}=e;return(0,a.useMemo)((()=>{if(void 0!==t)return t?void 0===n?void 0:"downscaled"===n?o:r.el:"original"===n?null==r?void 0:r.el:void 0}),[o,r,n,t])})({hasBeenRescaled:s,choice:c,downscaledImage:n,_originalImage:e}),{scale:p,cancelUpscale:h,progress:g,upscaledRef:f}=Oe(m,null==e?void 0:e.filename),w=(0,a.useCallback)((async n=>{if((null==n?void 0:n.src)!==(null==e?void 0:e.src)&&(u(),h(),n)){l(!1);const{src:e,filename:a}=n,r=await(e=>new Promise(((t,n)=>{let a=setTimeout((()=>{n(`Image load timed out in 5000ms. src: ${e}`)}),5e3);const o=new Image;o.src=e,o.crossOrigin="anonymous",o.onload=()=>{clearTimeout(a),t(o)},o.onerror=e=>{clearTimeout(a),n(e)}})))(e);t({src:e,filename:a,el:r});const s=(e=>{const t=600/Math.max(e.width,e.height),n=ke(e.width*t),a=ke(e.height*t);return n>e.width&&a>e.height?{width:e.width,height:e.height}:{width:n,height:a}})(r);if(((e,t)=>t.width!==e.width||t.height!==e.height)(r,s)){const e=De(r,s.width/r.width);o(e),i({width:s.width,height:s.height}),l(!0)}else d("original")}}),[e,h,t,d,l,o,u]),v=(0,a.useCallback)((e=>{d(e)}),[d]);return{cancelUpscale:h,originalSize:e?{width:e.el.width,height:e.el.height}:void 0,filename:null==e?void 0:e.filename,progress:g,setUploadedImage:w,img:m,downscaledImage:n,hasBeenRescaled:s,chooseWhichImageToUse:v,upscaledRef:null!=e&&e.src?f:void 0,scale:p,downscaledImageSize:r}},Me=document.createElement("style");function Le(){const e=(0,a.useCallback)((()=>{document.getElementById(o).style.minHeight=`calc(${window.innerHeight}px - 60px)`}),[]);(0,a.useEffect)((()=>{const t=document.getElementsByTagName("head")[0];t.appendChild(Me);const n=document.createElement("meta");return n.name="viewport",n.content="width=device-width, user-scalable=no",t.appendChild(n),e(),window.addEventListener("resize",e),()=>{t.removeChild(Me),t.removeChild(n),window.removeEventListener("resize",e)}}),[]);const{upscaledRef:t,originalSize:n,downscaledImage:r,chooseWhichImageToUse:s,setUploadedImage:l,img:c,hasBeenRescaled:d,progress:u,cancelUpscale:m,filename:p,downscaledImageSize:h,scale:g}=je(),{handleDownload:f}=((e,t,n)=>{const o=(0,a.useMemo)((()=>!(n&&void 0===t)),[t,n]),r=(0,a.useRef)(document.createElement("a"));(0,a.useEffect)((()=>{const t=r.current;t&&(t.href=n,t.download=e)}),[n,e]);const i=(0,a.useCallback)((()=>{const e=r.current;e&&e.click()}),[r]);return{handleDownload:o?void 0:i}})(p,u,t),w=(e=>{let{hasBeenRescaled:t,img:n,progress:o}=e;return(0,a.useMemo)((()=>1===o&&n?W.COMPLETE:n?W.PROCESSING:t&&void 0===n?W.WARNING:W.UPLOAD),[n,t,o])})({progress:u,hasBeenRescaled:d,img:c}),[v,E]=(0,a.useState)(.75),y=parseInt(""+100*u,10);return a.createElement(fe.Provider,{value:{handleUpload:l}},a.createElement("div",{id:o},w===W.UPLOAD&&a.createElement(Se,null),w===W.WARNING&&a.createElement(xe,{imgSize:h,downscaledCanvas:r,choose:s,originalSize:n}),c&&a.createElement(i,{ref:t,img:c,zoom:v,scale:g}),a.createElement(le,{cancelUpscale:m,selectImage:l,handleZoom:E,zoom:v,state:w,progress:void 0!==u&&a.createElement(j.mA,{value:y,label:`${y}%`},y,"%"),handleDownload:f})))}Me.type="text/css",Me.innerHTML=`\nbody {\n  position: fixed;\n  overflow: hidden !important;\n  width: 100%;\n}\nfooter {\n  display: none;\n}\n#${o} {\n  max-height: 500px;\n}\n`},59616:(e,t,n)=>{"use strict";n.d(t,{U:()=>ve,l:()=>Ee});var a=n(25681);const o=e=>(e=>Array.isArray(e))(e)?e[0]:e,r=(e=>{let{scale:t,name:n,version:a,meta:{architecture:r,...i},path:s}=e;return e=>{const l=s||`models/${t}x/model.json`;if("rdn"===r)return{scale:t,path:l,modelType:"layers",packageInformation:{name:n,version:a},meta:{architecture:r,...i},inputRange:[0,255],outputRange:[0,255]};const c=e.layers.Layer;return[class extends c{beta;constructor(){super({}),this.beta=.2}call(t){return e.mul(o(t),this.beta)}static className="MultiplyBeta"},(n=>{class a extends c{scale=n;constructor(){super({})}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(o(t),this.scale,"NHWC")}static className=`PixelShuffle${t}x`}return a})(t)].forEach((t=>{e.serialization.registerClass(t)})),{scale:t,path:l,modelType:"layers",packageInformation:{name:n,version:a},meta:{architecture:r,...i},inputRange:[0,1],outputRange:[0,1]}}})({scale:2,name:"@upscalerjs/default-model",version:"1.0.0-beta.14",path:"models/model.json",meta:{C:1,D:2,G:4,G0:64,T:10,architecture:"rdn",patchSize:128,size:"slim",artifactReducing:!1,sharpening:!1,dataset:"div2k",modelFileName:"rdn-C1-D2-G4-G064-T10-x2-patchsize128-compress100-sharpen0-datadiv2k-vary_cFalse_best-val_loss_epoch494"}}),i=r,s=e=>"tensor"===e?"tensor":"base64";var l=n(39727);const c=e=>!(!Boolean(e)||!Array.isArray(e)||4!==e.length)&&e.every((e=>null===e||"number"==typeof e)),d=e=>c(e)&&null!==e[1]&&null!==e[2]&&e[1]>0&&e[2]>0;function u(e){return function(t){try{return t.shape.length===e}catch(n){}return!1}}const m=u(4),p=u(3),h=e=>e instanceof l.esB;var g;!function(e){e.UNDEFINED="undefined",e.INVALID_MODEL_TYPE="invalidModelType",e.MISSING_PATH="missingPath"}(g||(g={}));class f extends Error{type;constructor(e){super(e),this.type=e}}const w=e=>"number"==typeof e,v=e=>Array.isArray(e)&&2===e.length&&e.every(w),E=['"padding" is undefined, but "patchSize" is explicitly defined.',"Without padding, patches of images often have visible artifacting at the seams. Defining an explicit padding will resolve the artifacting.","For more information, see https://upscalerjs.com/documentation/troubleshooting#padding-is-undefined.",'To hide this warning, pass an explicit padding of "0".'].join(" "),y=['The "progress" callback was provided but "patchSize" was not defined.','Without a "patchSize", the "progress" callback will never be called.',"For more information, see https://upscalerjs.com/documentation/troubleshooting#progress-specified-without-patch-size."].join(" "),S=["The model output was not a valid tensor. UpscalerJS only supports models returning valid tensors.","This is likely an error with the model itself, not UpscalerJS.","For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-model-prediction."].join(" "),b=new Error("No defined tensors were passed to concatTensors");class I extends Error{message="The upscale request received an abort signal"}const z=['You must provide a "path" when providing a model definition',"For more information, see https://upscalerjs.com/documentation/troubleshooting#missing-model-path."].join(" "),_="There is a bug with the upscaler code. Please report this.",C=["You have provided a patchSize, but the model definition already includes an input size.","Your patchSize will be ignored.","For more information, see https://upscalerjs.com/documentation/troubleshooting#input-size-and-patch-size."].join(" "),T=new Error(["Model input sizes must be square. If you are using a model with a non-square input size and would like to request support,","please file a feature request at https://github.com/thekevinscott/upscalerjs"].join(" "));function N(e,t){switch(e){case g.MISSING_PATH:return new Error(z);case g.INVALID_MODEL_TYPE:return new Error((n=null==t?void 0:t.modelType,[`You've provided an invalid model type: ${JSON.stringify(n)}. Accepted types are "layers" and "graph".`,"For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-model-type."].join(" ")));default:return new Error(_)}var n}const x=e=>{console.warn(Array.isArray(e)?e.join("\n"):e)};function k(e){return void 0!==e&&"function"==typeof e}const D=(e,t,n)=>!(!k(e)||e.length<=1)&&(void 0===n&&"tensor"===t||"tensor"===n);async function A(e,t){let n;for(n=await e.next();!n.done;n=await e.next())t&&await t(n.value);return n.value}function R(e){return null!=e}function U(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];const r=n.filter(R);if(r.length){const t=a.tidy((()=>r.reduce(((e,t)=>t(e)),e)));return e.isDisposed||e===t||e.dispose(),t}return e}function P(e,t){return"graph"===t?a.loadGraphModel(e):a.loadLayersModel(e)}const O=e=>(e=>e instanceof a.LayersModel)(e)?e.layers[0].batchInputShape:e.inputs[0].shape,j=e=>{let{model:t}=e;const n=O(t);if(!c(n))throw new Error((a=n,[`Expected model to have a rank-4 compatible input shape. Instead got: ${JSON.stringify(a)}.`,"For more information, see https://upscalerjs.com/documentation/troubleshooting#error-with-model-input-shape."].join(" ")));var a;return n},M=(e,t)=>Math.ceil(t/e)*e,L=(e,t,n)=>{let{patchSize:a,padding:o}=t;const r=j(e);if(void 0!==a){if(a<=0)throw(e=>new Error([`Invalid patch size: ${e}. Patch size must be greater than 0.`].join(" ")))(a);if(void 0!==o&&2*o>=a)throw((e,t)=>new Error([`Invalid patch size and padding: ${e} and ${t}. Patch size must be greater than padding * 2.`].join(" ")))(a,o)}if(d(r)){if(void 0!==a&&x(C),r[1]!==r[2])throw T;return{patchSize:r[1],padding:o,modelInputShape:r}}void 0!==a&&void 0===o&&x(E);const{divisibilityFactor:i}=e.modelDefinition;if(void 0!==i){if(void 0!==a){const e=M(i,a);return e!==a&&x(((e,t,n)=>[`Invalid patch size: ${e}. The model has a defined divibility factor of ${t} and patch size must be a multiple of this number.`,`Patch size has been scaled up to ${n}.`,"\nFor more information, see https://upscalerjs.com/documentation/troubleshooting#patch-size-indivisible-by-divisibility-factor."].join(" "))(a,i,e)),{patchSize:e,padding:o,modelInputShape:[null,e,e,3]}}return{patchSize:void 0,padding:void 0,modelInputShape:[null,M(i,n[1]),M(i,n[2]),3]}}return{patchSize:a,padding:o,modelInputShape:void 0}},F={jsdelivr:(e,t,n)=>`https://cdn.jsdelivr.net/npm/${e}@${t}/${n}`,unpkg:(e,t,n)=>`https://unpkg.com/${e}@${t}/${n}`},G=["jsdelivr","unpkg"];async function $(e){let{path:t,modelType:n,packageInformation:a}=e;if(a){const e=[];for(let r=0;r<G.length;r++){const i=G[r],s=F[i];try{const e=s(a.name,a.version,t);return await P(e,n)}catch(o){e.push([i,o instanceof Error?o:new Error(`There was an unknown error: ${JSON.stringify(o)}`)])}}throw((e,t,n)=>new Error([`Could not resolve URL ${e} for package ${t.name}@${t.version}`,"Errors include:",...n.map((e=>{let[t,n]=e;return`- ${t}: ${n.message}`}))].join("\n")))(t,a,e)}return await P(t,n)}const B=async e=>{try{(e=>{if(void 0===e)throw new f(g.UNDEFINED);if("string"!=typeof(t=e.modelType||"layers")||!["layers","graph"].includes(t))throw new f(g.INVALID_MODEL_TYPE);var t;if(!e.path)throw new f(g.MISSING_PATH)})(e)}catch(n){throw n instanceof f?N(n.type,e):new Error(_)}const t=(e=>({...e}))(e);return{model:await $(t),modelDefinition:t}},H=(e,t)=>async n=>{if(t&&await a.nextFrame(),(o=e)&&o.aborted)throw Array.isArray(n)?n.forEach((e=>null==e?void 0:e.dispose())):h(n)&&n.dispose(),new I;var o},J=e=>!(!e||"object"!=typeof e)&&("patchSize"in e&&"number"==typeof e.patchSize),Z=e=>Boolean(e)&&"number"==typeof e&&e>0,q=e=>new Error((e=>["Invalid value passed to warmup in warmupSizes:",JSON.stringify(e),"For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-warmup-value."].join("\n"))(e)),W=e=>{if(J(e)){const{patchSize:t}=e;return t}return e};const V=async function(e,t,n,o){let{signal:r,awaitNextFrame:i=!1}=void 0===n?{}:n;const s=H(r||o.signal,i);await s(),await A(async function*(e,t){const{model:n,modelDefinition:o}=await e;for(const r of t){if(!J(r)&&!Z(r))throw q(r);const e=W(r);let t=a.zeros([1,e,e,3]);yield[t];const i=[o.preprocess,e=>n.predict(e),o.postprocess].filter(Boolean);for(const n of i)t=U(t,n),yield[t];t.dispose(),yield}}(e,(e=>{if(Array.isArray(e)){for(const t of e)if(!J(t)&&!Z(t))throw q(e);return e}if(J(e)||Z(e))return[e];throw q(e)})(t)),s)},Y=(e,t)=>n=>{const o=e[1]*t,r=e[2]*t;return o<n.shape[1]||r<n.shape[2]?a.tidy((()=>a.slice(n,[0,0,0],[1,o,r,3]))):n},K=e=>t=>{const n=v(e)?e[1]:255;return t.clipByValue(0,n).mul(1===n?255:1)};function X(e,t){void 0===t&&(t=0);const n=e.filter(R);if(0===n.length)throw b;const o=a.concat(n,t);return e.forEach((e=>null==e?void 0:e.dispose())),o}const Q=()=>new Error(["Environment does not support a string URL as an input format.","For more information, see https://upscalerjs.com/documentation/troubleshooting#environment-disallows-string-input."].join("\n")),ee=()=>new Error(["Environment does not support base64 as an output format.","For more information, see https://upscalerjs.com/documentation/troubleshooting#environment-disallows-base64."].join("\n")),te=e=>new Promise(((t,n)=>{const a=new Image;a.src=e,a.crossOrigin="anonymous",a.onload=()=>t(a),a.onerror=()=>n(new Error(["Failed to load image"].join(" ")))})),ne=e=>a.browser.fromPixelsAsync(e),ae=async e=>{const t=await(async e=>{if(h(e))return e;if("string"==typeof e){const t=await te(e);return ne(t)}return ne(e)})(e);if(p(t)){const e=t.expandDims(0);return t.dispose(),e}if(m(t))return t;throw(e=>new Error([`Unsupported dimensions for incoming pixels: ${e.shape.length}.`,"Only 3 or 4 rank tensors are supported."].join("\n")))(t)},oe=e=>{const t=(e=>a.tidy((()=>{const[t,n]=e.shape,o=a.fill([t,n],255).expandDims(2);return e.clipByValue(0,255).concat([o],2).dataSync()})))(e),[n,o]=e.shape,r=new ImageData(o,n);r.data.set(t);const i=document.createElement("canvas");i.width=o,i.height=n;const s=i.getContext("2d");if(!s)throw new Error("No context found");return s.putImageData(r,0,0),i.toDataURL()},re=e=>{try{new Image&&document}catch(t){throw e()}},ie=(e,t,n,a)=>{let o=t;const r=0===t||n===e?0:a,i=o+n>e;let s=i?n-(e-o):0;const l=i||n===e?0:a,c=i?0:r;let d=n-(i?s:0);i&&(o=e-n),o-=c,s+=c,d-=c+l;return{pre:{origin:o,size:n},post:{origin:s,size:d},increment:n>e?e:n-r-l}},se=(e,t,n,a)=>(e*n+t+1)/a,le=(e,t)=>{const n=e.predict(t);if(!h(n))throw new Error(S);if(m(n))return n;throw new Error((a=n.shape,[`The tensor returned by the model was not a valid rank-4 tensor. It's shape is ${JSON.stringify(a)}.}`,"UpscalerJS only supports models returning valid image-like data in four dimensional form.","For more information, see https://upscalerjs.com/documentation/troubleshooting#invalid-predicted-tensor."].join(" ")));var a};async function*ce(e,t,n,a){let{output:o,progress:r,progressOutput:i}=t,{originalImageSize:s,patchSize:l,padding:c=0}=a;const{model:d,modelDefinition:u}=n,m=u.scale||1;if(l){var p;const[t,n]=e.shape.slice(1),a=((e,t,n)=>{let[a,o]=e;const r=[];let i=0,s=0;for(;s<o;){const{pre:{origin:e,size:l},post:{origin:c,size:d},increment:u}=ie(o,s,Math.min(t,o),n),m=[];for(;i<a;){const{pre:{origin:o,size:r},post:{origin:s,size:u},increment:p}=ie(a,i,Math.min(t,a),n);m.push({pre:{origin:[e,o],size:[l,r]},post:{origin:[c,s],size:[d,u]}}),i+=p}r.push(m),i=0,s+=u}return r})([n,t],l,c);let g;yield;const f=a.length*a[0].length;for(let s=0;s<a.length;s++){const t=a[s],n=t.length;let l;yield[l,g];for(let a=0;a<n;a++){const{pre:c,post:p}=t[a];yield[g,l];const w=e.slice([0,...c.origin],[-1,...c.size]);yield[g,l,w];const v=le(d,w);w.dispose(),yield[g,l,v];const E=[0,p.origin[0]*m,p.origin[1]*m],y=[-1,p.size[0]*m,p.size[1]*m],S=v.slice(E,y);v.dispose(),yield[g,l,S];const b=U(S,u.postprocess,K(u.outputRange));if(yield[g,l,b],void 0!==r&&k(r)){const e=se(s,a,n,f);if(k(h=r)&&h.length<=1)r(e);else{const t=b.squeeze();if(D(r,o,i))r(e,t,s,a);else{const n=oe(t);t.dispose(),r(e,n,s,a)}}}yield[g,l,b],l=X([l,b],2),b.dispose(),yield[g,l]}g=X([g,l],1),l.dispose(),yield[g]}const w=U(g.clone(),Y(s,m));null==(p=g)||p.dispose(),yield[w];const v=w.squeeze();return w.dispose(),v}var h;r&&x(y);const g=le(d,e);yield[g];const f=U(g.clone(),u.postprocess,K(u.outputRange),Y(s,m));g.dispose(),yield[f];const w=f.squeeze();return f.dispose(),w}async function*de(e,t,n){const o=(e=>h(e)?e.clone():e)(e),r=await ae(o);yield r;const i=r.shape,{patchSize:s,padding:l,modelInputShape:c}=L(n,t,i),u=U(r,n.modelDefinition.preprocess,(p=n.modelDefinition.inputRange,e=>v(p)&&1===p[1]?a.mul(e,1/255):e),c?(m=c,e=>{const t=e.shape[1],n=e.shape[2];return d(m)&&(m[1]>t||m[2]>n)?a.tidy((()=>{const o=Math.max(t,m[1]),r=Math.max(n,m[2]),i=a.zeros([1,t,r-n,3]),s=a.zeros([1,o-t,r,3]),l=a.concat([e,i],2);return a.concat([l,s],1)})):e}):void 0);var m,p;yield u;const g=ce(u,{output:t.output,progressOutput:t.progressOutput,progress:t.progress},n,{originalImageSize:i,patchSize:s,padding:l});let f=await g.next();for(yield f.value;!f.done;)f=await g.next(),Array.isArray(f.value)?yield[...f.value,u]:h(f.value)?yield[f.value,u]:yield u;u.dispose();const w=f.value;if("tensor"===t.output)return w;const E=oe(w);return w.dispose(),E}async function ue(e,t,n){let{signal:a,awaitNextFrame:o,...r}=t;((e,t)=>{let{output:n="base64",progressOutput:a}=t;"string"==typeof e&&re(Q),"base64"!==a&&"base64"!==n||re(ee)})(e,{output:r.output,progressOutput:r.progressOutput});const i=H(a||n.signal,o);await i();const s=await A(de(e,r,n),i);return await i(),s}const me=i;const pe=class{_opts;_model;ready;_abortController=new AbortController;constructor(e){void 0===e&&(e={}),this._opts={...e},this._model=B(function(e){return function(e){return"function"==typeof e}(e)?e(a):e}(this._opts.model||me)),this.ready=new Promise(((e,t)=>{this._model.then((()=>V(this._model,this._opts.warmupSizes||[],void 0,{signal:this._abortController.signal}))).then(e).catch(t)}))}async execute(e,t){await this.ready;const n=await this._model;return ue(e,function(e){let{output:t,progressOutput:n,...a}=void 0===e?{}:e;return{...a,output:s(t),progressOutput:s(n||t)}}(t),{...n,signal:this._abortController.signal})}upscale=this.execute.bind(this);warmup=(()=>{var e=this;return async function(t,n){return void 0===t&&(t=[]),await e.ready,V(e._model,t,n,{signal:e._abortController.signal})}})();abort=()=>{this._abortController.abort(),this._abortController=new AbortController};dispose=async()=>{await this.ready;const{model:e}=await this._model;e.dispose()};getModel=()=>this._model},he=e=>(e=>Array.isArray(e))(e)?e[0]:e,ge=e=>{let{scale:t,name:n,version:a,meta:{architecture:o,...r},path:i}=e;return e=>{const s=i||`models/${t}x/model.json`;if("rdn"===o)return{scale:t,path:s,modelType:"layers",packageInformation:{name:n,version:a},meta:{architecture:o,...r},inputRange:[0,255],outputRange:[0,255]};const l=e.layers.Layer;return[class extends l{beta;constructor(){super({}),this.beta=.2}call(t){return e.mul(he(t),this.beta)}static className="MultiplyBeta"},(n=>{class a extends l{scale=n;constructor(){super({})}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(he(t),this.scale,"NHWC")}static className=`PixelShuffle${t}x`}return a})(t)].forEach((t=>{e.serialization.registerClass(t)})),{scale:t,path:s,modelType:"layers",packageInformation:{name:n,version:a},meta:{architecture:o,...r},inputRange:[0,1],outputRange:[0,1]}}},fe=(e,t)=>ge({scale:e,path:`models/${e}x/model.json`,name:"@upscalerjs/esrgan-medium",version:"1.0.0-beta.9",meta:{C:1,D:10,G:64,G0:64,T:10,architecture:"rdn",patchSize:3===e?129:128,size:"medium",artifactReducing:!1,sharpening:!1,dataset:"div2k",modelFileName:t}}),we=fe(4,"rdn-C1-D10-G64-G064-T10-x4-patchsize128-compress100-sharpen0-datadiv2k-vary_cFalse_best-val_loss_epoch490");let ve,Ee,ye,Se,be;!function(e){e[e.INSTANTIATE=0]="INSTANTIATE",e[e.UPSCALE=1]="UPSCALE",e[e.ABORT=2]="ABORT",e[e.SET_ID=3]="SET_ID"}(ve||(ve={})),function(e){e[e.PROGRESS=0]="PROGRESS",e[e.SEND_CONSTS=1]="SEND_CONSTS"}(Ee||(Ee={}));let Ie=()=>{},ze=new Promise((e=>{Ie=e}));onmessage=async e=>{let{data:{type:t,data:n}}=e;if(t===ve.INSTANTIATE)if(ye)console.warn("Was asked to instantiate UpscalerJS, but it already exists.");else{ye=new pe({model:we});const{modelDefinition:e}=await ye.getModel();be=e.scale,postMessage({type:Ee.SEND_CONSTS,data:{scale:be,patchSize:32}}),await ye.warmup([{patchSize:32}]),Ie(),console.log("UpscalerJS warmup complete.")}else if(t===ve.SET_ID){try{ye.abort()}catch(o){}if(!n)throw new Error("No data in set id");Se=n.id}else if(t===ve.UPSCALE){if(await ze,!ye)throw new Error("Instantiate an Upscaler first.");const{pixels:e,shape:t,patchSize:r,padding:i}=n,s=a.tensor3d(e,t);try{await ye.execute(s,{output:"tensor",patchSize:r,padding:i,progress:(e,t,n,a)=>{postMessage({type:Ee.PROGRESS,data:{id:Se,rate:e,row:n,col:a,slice:t.dataSync(),shape:t.shape}}),t.dispose()}})}catch(o){if(!(o instanceof I))throw o}s.dispose()}else if(t===ve.ABORT)try{ye.abort()}catch(o){}}},61853:(e,t,n)=>{"use strict";n.d(t,{T:()=>o});var a=n(49231);function o(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];const r=(0,a.useRef)(),i=(0,a.useCallback)((t=>{const n=t.target;e&&e(n,t)}),[e,JSON.stringify(n)]);return(0,a.useEffect)((()=>{const e=r.current;if(e)return n.forEach((t=>{e.addEventListener(t,i)})),()=>{n.forEach((t=>{e.removeEventListener(t,i)}))}}),[i,r]),r}},99832:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>i});var a=n(49231),o=n(81245),r=n(2079);function i(){return a.createElement(r.Z,{title:"Demo",description:"A Demo of UpscalerJS"},a.createElement(o.Z,null,(()=>{const{Demo:e}=n(19464);return a.createElement(e,null)})))}},57897:()=>{},94444:()=>{},43237:()=>{},93153:()=>{},18116:()=>{},41402:()=>{}}]);