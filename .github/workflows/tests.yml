name: 'Tests'
on: [push]

jobs:
  lint:
    name: 'Lint'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        run: yarn

      - name: 'Lint'
        run: yarn lint

  memory-leaks:
    name: 'Memory Leaks'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: '16'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        run: yarn

      - name: 'Memory Leak Tests'
        run: yarn test:memory-leaks

  unit-browser:
    name: 'Unit / Browser'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: '16'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        run: yarn

      - name: 'Unit Tests / Jest'
        run: yarn test:unit:browser:jest

      - name: 'Unit Tests / Playwright'
        run: yarn test:unit:browser:playwright

      - name: 'Codecov'
        uses: codecov/codecov-action@v1
        with:
          directory: ./packages/upscalerjs/coverage
          verbose: true

  unit-node:
    name: 'Unit / Node'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: '16'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        run: yarn

      - name: 'Unit Tests'
        run: yarn test:unit:node

      - name: 'Codecov'
        uses: codecov/codecov-action@v1
        with:
          directory: ./packages/upscalerjs/coverage
          verbose: true

  integration-browser-browserstack:
    name: 'Integration / Browser / Browserstack'
    runs-on: ubuntu-latest
    steps:
      - name: 'BrowserStack Env Setup'  # Invokes the setup-env action
        uses: browserstack/github-actions/setup-env@master
        with:
          username: ${{ secrets.BROWSERSTACK_USERNAME }}
          access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn

      - name: 'Integration Tests'
        run: yarn test:integration:browserstack --ci
        env:
          NODE_OPTIONS: --max_old_space_size=8192

  integration-browser-local:
    name: 'Integration / Browser / Local'
    runs-on: ubuntu-latest
    steps:
      - name: 'BrowserStack Env Setup'  # Invokes the setup-env action
        uses: browserstack/github-actions/setup-env@master
        with:
          username: ${{ secrets.BROWSERSTACK_USERNAME }}
          access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn

      - name: 'Integration Tests'
        run: yarn test:integration:browser --ci
        env:
          NODE_OPTIONS: --max_old_space_size=8192

  integration-node-local-16:
    name: 'Integration / Node / Local / v16'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: '16'

      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: 'Installing'
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: yarn

      - name: 'Installing Node-specific deps'
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: cd test/lib/node && yarn

      - name: 'Integration Tests'
        run: yarn test:integration:node --ci
